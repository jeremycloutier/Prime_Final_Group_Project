function getServedInDateRange(a,b,c){if(isNaN(b)||isNaN(c))return null;for(var d=[],e=0;e<a.length;e++){var f=Date.parse(a[e].classStart);isNaN(f)||f>=b&&c>=f&&d.push(a[e])}return console.log("served in date range",d),d}function getCompleted(a,b,c){if(isNaN(b)||isNaN(c))return null;for(var d=[],e=0;e<a.length;e++){var f=Date.parse(a[e].classStart);isNaN(f)||a[e].gradDate&&f>=b&&c>=f&&d.push(a[e])}return console.log("completed: ",d),d}function getCertifiedAPlus(a,b,c){if(isNaN(b)||isNaN(c))return null;for(var d=[],e=0;e<a.length;e++){var f=Date.parse(a[e].classStart);isNaN(f)||a[e].certDate&&f>=b&&c>=f&&d.push(a[e])}return console.log("certified A+ rows in pie",d),d}function getPlaced(a,b,c){if(isNaN(b)||isNaN(c))return null;for(var d=[],e=0;e<a.length;e++){var f=Date.parse(a[e].classStart);isNaN(f)||a[e].placedFullTime&&f>=b&&c>=f&&d.push(a[e])}console.log("placed rows in pie",d)}function slicePieByRace(a){for(var b=0,c=0,d=0,e=0,f=0,g=0;g<a.length;g++){var h=a[g].ethnicity;"Black / African American"==h?b++:"White"==h?c++:"Hispanic / Latino"==h?d++:"Other, Multi-Racial"==h?f++:"Asian"==h&&e++}return[{label:"Black",count:b},{label:"White",count:c},{label:"Latino",count:d},{label:"Asian",count:e},{label:"Other",count:f}]}function slicePieByGender(a){for(var b=0,c=0,d=0;d<a.length;d++){var e=a[d].female;e?c++:b++}return[{label:"Male",count:b},{label:"Female",count:c}]}function slicePieByVeteran(a){for(var b=0,c=0,d=0;d<a.length;d++)a[d].veteran?b++:c++;return[{label:"Veteran",count:b},{label:"Non-veterans",count:c}]}function genLineData(){var a=[[{x:new Date(2012,5,7),y:2},{x:new Date(2012,8,7),y:4},{x:new Date(2013,10,7),y:6},{x:new Date(2014,11,7),y:7},{x:new Date(2015,12,7),y:9}],[{x:new Date(2012,5,7),y:10},{x:new Date(2012,8,7),y:8},{x:new Date(2013,10,7),y:6},{x:new Date(2014,11,7),y:6},{x:new Date(2015,12,7),y:5}]];return a}function genLineGraph(a,b){console.log("yo, line chart");var c=800,d=500,e=60,f=genLineData(),g=d3.scale.category10(),h=d3.extent(d3.merge(f),function(a){return a.y}),i=d3.time.scale().domain([a,b]).range([e,c-2*e]),j=d3.svg.axis().scale(i).orient("bottom").ticks(d3.time.months,6).tickSize(12,12).tickFormat(d3.time.format("%b. '%y")),k=d3.scale.linear().domain([h[0],h[1]]).range([d-e,e]);d3.select("svg").remove();var l=d3.select(".lineControls").append("svg").attr("width",c).attr("height",d).attr("opacity","1"),m=d3.svg.axis().scale(k).orient("left").ticks(8);l.append("g").attr("class","axis").attr("transform","translate(0,"+(d-e)+")").call(j),l.append("g").attr("class","axis").attr("transform","translate("+e+",0)").call(m);var n=l.selectAll("g.line").data(f);n.enter().append("g").attr("class","line").attr("style",function(a){return"stroke: "+g(f.indexOf(a))}),n.selectAll("path").data(function(a){return[a]}).enter().append("path").attr("d",d3.svg.line().x(function(a){return i(a.x)}).y(function(a){return k(a.y)}))}var app=angular.module("myApp",["ngRoute"]);app.controller("MainController",["$scope","$location","SmartSheetService",function(a,b,c){function d(a,b,c,d){var e={},f=Date.parse(a.classStart);if(isNaN(f)||isNaN(b)||isNaN(c))return null;if(f>c||b>f)return null;var g=0,h=0,i=Date.parse(a.employHistory.start),j=Date.parse(a.employHistory.end);i&&!isNaN(i)&&(h=((new Date-i)/1e3/3600/24).toFixed(0),g=j&&!isNaN(j)?(j-i)/1e3/3600/24:-1);for(var k=Object.keys(d),l=0;l<k.length&&!(h<d[k[l]]);l++){if(!(0>g||g>=d[k[l]])){for(var m=l;m<k.length&&!(h<d[k[m]]);m++)e[k[m]]=!1;break}e[k[l]]=!0}return e}function e(a,b,c){for(var e={threeMonth:90,sixMonth:180,oneYear:365,twoYear:730,threeYear:1095,fourYear:1460,fiveYear:1825},f=Object.keys(e),g={},h={},i=0;i<f.length;i++)g[f[i]]={numRetained:0,fraction:null,percent:null},h[f[i]]=0;var j={},k={};for(i=0;i<a.length;i++)if(j=d(a[i],b,c,e)){k=Object.keys(j);for(var l=0;l<k.length;l++)j[k[l]]&&g[k[l]].numRetained++,h[k[l]]++}for(i=0;i<f.length;i++)h[f[i]]<=0?(g[f[i]].fraction="N/A",g[f[i]].percent="N/A"):(g[f[i]].fraction=g[f[i]].numRetained+" / "+h[f[i]],g[f[i]].percent=(g[f[i]].numRetained/h[f[i]]*100).toFixed(1)+"%");return g}function f(a,b,c){for(var d=0,e=0,f=0,h=0;h<a.length;h++)f=g(a[h],b,c),f&&(d+=f,e++);return(d/e).toFixed(2)}function g(a,b,c){var d=Date.parse(a.classStart);return isNaN(d)||isNaN(b)||isNaN(c)?null:a.employHistory.start&&d>=b&&c>=d&&a.wages.length>0?a.wages[0]:null}function h(a,b,c){for(var d=0,e=0,f=0,g=0;g<a.length;g++)f=i(a[g],b,c),f&&(d+=f,e++);return(d/e).toFixed(2)}function i(a,b,c){var d=Date.parse(a.classStart);return isNaN(d)||isNaN(b)||isNaN(c)?null:a.employHistory.start&&!a.employHistory.end&&d>=b&&c>=d&&a.wages.length>0?a.wages[a.wages.length-1]:null}function j(a,b,c,d){var e=0,f=0,g=0,h={};if(isNaN(c)||isNaN(d))return null;for(var j=0;j<b.length;j++){var k=Date.parse(b[j].classStart);if(!isNaN(k)&&k>=c&&d>=k)for(var l=0;l<a.length;l++){var m=a[l];if(!b[j][m])break;l==a.length-1&&(f=i(b[j],c,d),f&&(e+=f,g++))}}return h.avgWage=(e/g).toFixed(2),h.count=g,h}function k(b,c,d){if(isNaN(c)||isNaN(d))return null;var e={};a.topFive=[];for(var f=0;f<b.length;f++){var g=Date.parse(b[f].classStart);if(!isNaN(g)&&g>=c&&d>=g)for(var h=0;h<b[f].distinctEmployers.length;h++){var i=b[f].distinctEmployers[h];e.hasOwnProperty(i)||(e[i]=0),e[i]++}}a.sortedEmployers=n(e);for(var j=0;5>j;j++)a.topFive.push(a.sortedEmployers.pop());return a.topFive}function l(a,b){var c=b;return a&&c.number++,c}function m(b){var c=b;return c.number&&(c.percent=Number(Math.round(c.number/a.numServed*100+"e2")+"e-2")),c}function n(a){var b,c=[];for(b in a)a.hasOwnProperty(b)&&c.push({key:b,value:a[b]});return c.sort(function(a,b){return a.value-b.value}),c}a.endDate=new Date,a.startDate=new Date("2012-05-08"),a.smartSheetData=[],c.getSmartSheetData().then(function(b){a.smartSheetData=b.data,a.submitDate()}),a.genLineGraph=genLineGraph,a.submitDate=function(){a.numServed=0,a.completed={number:0,percent:0},a.certified={number:0,percent:0},a.placed={number:0,percent:0},a.certNetwork={number:0,percent:0},a.certServer={number:0,percent:0},a.certSecurity={number:0,percent:0},a.networkPlus=!1,a.securityPlus=!1,a.serverPlus=!1,a.otherCert=!1,a.calculatedSalary={};for(var b=0;b<a.smartSheetData.length;b++){var c=new Date(a.smartSheetData[b].classStart),d=c.setDate(c.getDate()+1);d>=a.startDate&&d<=a.endDate&&(a.numServed++,a.completed=l(a.smartSheetData[b].gradDate,a.completed),a.certified=l(a.smartSheetData[b].certDate,a.certified),a.placed=l(a.smartSheetData[b].employHistory.start,a.placed),a.certNetwork=l(a.smartSheetData[b].networkPlus,a.certNetwork),a.certServer=l(a.smartSheetData[b].serverPlus,a.certServer),a.certSecurity=l(a.smartSheetData[b].securityPlus,a.certSecurity))}a.completed=m(a.completed),a.certified=m(a.certified),a.placed=m(a.placed),a.certNetwork=m(a.certNetwork),a.certServer=m(a.certServer),a.certSecurity=m(a.certSecurity);var g=new Date(a.startDate);g.setDate(g.getDate()-1),a.avgWageAtPlacement=f(a.smartSheetData,g,Date.parse(a.endDate)),a.avgCurrentWage=h(a.smartSheetData,g,Date.parse(a.endDate)),a.getTopFive=k(a.smartSheetData,g,Date.parse(a.endDate)),a.retentionData=e(a.smartSheetData,g,Date.parse(a.endDate)),a.generatePieCharts()},a.calcAvgSalary=function(){a.tempCertArray=[],a.networkPlus&&a.tempCertArray.push("networkPlus"),a.serverPlus&&a.tempCertArray.push("serverPlus"),a.securityPlus&&a.tempCertArray.push("securityPlus"),a.otherCert&&a.tempCertArray.push("otherCert");var b=new Date(a.startDate);b.setDate(b.getDate()-1),a.calculatedSalary=j(a.tempCertArray,a.smartSheetData,b,Date.parse(a.endDate))},a.generatePieCharts=function(){d3.select("svg").remove();var b=new Date(a.startDate);b.setDate(b.getDate()-1);var c=[],d=[];a.pieHeading="","Served"==a.selectedProgress?(console.log("get all data"),c=getServedInDateRange(a.smartSheetData,b,Date.parse(a.endDate))):"Completed"==a.selectedProgress?(console.log("get completed"),c=getCompleted(a.smartSheetData,b,Date.parse(a.endDate))):(a.selectedProgress="Certified A+")?(console.log("get certified A+ data"),c=getCertifiedAPlus(a.smartSheetData,b,Date.parse(a.endDate))):(a.selectedProgress="Placed")&&(console.log("get Placed data"),c=getPlaced(a.smartSheetData,b,Date.parse(a.endDate))),"Race"==a.selectedDemographic?(d=slicePieByRace(c),a.pieHeading="Race"):"Gender"==a.selectedDemographic?(console.log("slicing by gender"),d=slicePieByGender(c),console.log("gender dataset after slice",d),a.pieHeading="Gender"):"Veteran Status"==a.selectedDemographic&&(d=slicePieByVeteran(c),console.log("veteran dataset",d),a.pieHeading="Veteran Status"),function(a){"use strict";var b=360,c=360,e=Math.min(b,c)/2,f=a.scale.ordinal().range(["blue","red","green","orange","purple","yellow"]),g=18,h=4,i=a.select("#chart").append("svg").attr("width",b).attr("height",c).append("g").attr("transform","translate("+b/2+","+c/2+")"),j=a.svg.arc().outerRadius(e),k=a.layout.pie().value(function(a){return a.count}).sort(null),l=(i.selectAll("path").data(k(d)).enter().append("path").attr("d",j).attr("fill",function(a,b){return f(a.data.label)}),i.selectAll(".pieLegend").data(f.domain()).enter().append("g").attr("class","pieLegend").attr("transform",function(a,b){var c=g+h,d=c*f.domain().length/2,e=-12*g,i=b*c-d;return"translate("+e+","+i+")"}));l.append("rect").attr("width",g).attr("height",g).style("fill",f).style("stroke",f),l.append("text").attr("x",g+h).attr("y",g-h).text(function(a){return a})}(window.d3)},a.demographicList=["Gender","Age","Race","Veteran Status"],a.progressList=["Served","Completed","Certified A+","Placed"],a.lineGraphList=["Gender","Age","Race","Veteran Status","Wage at Placement","Placement Rates","Graduation Rates"],a.selectedDemographic="Gender",a.selectedProgress="Served",a.selectedLineGraph="Gender",a.tab="a",a.chartTab="pie",a.averageShow=!1,a.generateCharts=function(a,b){console.log("demographics, progress",a,b)},a.showAverageSalary=function(){a.averageShow=!0},a.hideAverageSalary=function(){a.averageShow=!1}}]),app.factory("SmartSheetService",["$http",function(a){var b=function(){return a.get("/api")};return{getSmartSheetData:b}}]);