function getRange(a,b,c,d){if(isNaN(b)||isNaN(c))return null;var e=[];if("Served"==d){for(var f=0;f<a.length;f++){var g=Date.parse(a[f].classStart);isNaN(g)||g>=b&&c>=g&&e.push(a[f])}return e}if("Completed"==d){for(var f=0;f<a.length;f++){var g=Date.parse(a[f].classStart);isNaN(g)||a[f].gradDate&&g>=b&&c>=g&&e.push(a[f])}return e}if("Certified A+"==d){for(var f=0;f<a.length;f++){var g=Date.parse(a[f].classStart);isNaN(g)||a[f].certDate&&g>=b&&c>=g&&e.push(a[f])}return e}if("Placed"==d){for(var f=0;f<a.length;f++){var g=Date.parse(a[f].classStart);isNaN(g)||a[f].placedFullTime&&g>=b&&c>=g&&e.push(a[f])}return e}}function slicePieByAge(a){for(var b=0,c=0,d=0,e=0,f=0,g=0,h=0,i=0,j=0,k=0,l=0,m=0,n=0;n<a.length;n++){var o=a[n].ageAtStart;18>o?(b++,a[n].employHistory.start&&a[n].wages.length>0&&(h+=a[n].wages[0],console.log("salarySumUnder18 update",h))):24>o?(c++,console.log("count 18 to 24",c),a[n].employHistory.start&&a[n].wages.length>0&&(i+=a[n].wages[0].toFixed(2),console.log("salarySum18to24 update",i))):30>o?(d++,a[n].employHistory.start&&a[n].wages.length>0&&(j+=a[n].wages[0],console.log("salarySum24to30 update",j))):40>o?(e++,a[n].employHistory.start&&a[n].wages.length>0&&(k+=a[n].wages[0])):50>o?(f++,a[n].employHistory.start&&a[n].wages.length>0&&(l+=a[n].wages[0])):(g++,a[n].employHistory.start&&a[n].wages.length>0&&(m+=a[n].wages[0]))}return[{label:"Under 18",count:b,averageSalary:(h/b).toFixed(2)},{label:"18 to 24",count:c,averageSalary:(i/c).toFixed(2)},{label:"24 to 30",count:d,averageSalary:(j/d).toFixed(2)},{label:"30 to 40",count:e,averageSalary:(k/e).toFixed(2)},{label:"40 to 50",count:f,averageSalary:(l/f).toFixed(2)},{label:"Over 50",count:g,averageSalary:(m/g).toFixed(2)}]}function slicePieByRace(a){for(var b=0,c=0,d=0,e=0,f=0,g=0,h=0,i=0,j=0,k=0,l=0;l<a.length;l++){var m=a[l].ethnicity,n=a[l].wages[0];"Black / African American"==m?(b++,a[l].employHistory.start&&a[l].wages.length>0&&(g+=n,console.log("totalBlackSalary update:",g))):"White"==m?(c++,a[l].employHistory.start&&a[l].wages.length>0&&(h+=n,console.log("totalWhiteSalary update:",h))):"Hispanic / Latino"==m?(d++,a[l].employHistory.start&&a[l].wages.length>0&&(i+=n,console.log("totalLatinoSalary update:",i))):"Other, Multi-Racial"==m?(f++,a[l].employHistory.start&&a[l].wages.length>0&&(k+=n,console.log("totalOtherSalary update:",k))):"Asian"==m&&(e++,a[l].employHistory.start&&a[l].wages.length>0&&(j+=n,console.log("totalAsianSalary update:",j)))}return[{label:"Black",count:b,averageSalary:(g/b).toFixed(2)},{label:"White",count:c,averageSalary:(h/c).toFixed(2)},{label:"Latino",count:d,averageSalary:(i/d).toFixed(2)},{label:"Asian",count:e,averageSalary:(j/e).toFixed(2)},{label:"Other",count:f,averageSalary:(k/f).toFixed(2)}]}function slicePieByGender(a){for(var b=0,c=0,d=0,e=0,f=0;f<a.length;f++){var g=a[f].female,h=a[f].wages[0];g?(c++,a[f].employHistory.start&&a[f].wages.length>0&&(d+=h)):(b++,a[f].employHistory.start&&a[f].wages.length>0&&(e+=h))}return[{label:"Male",count:b,averageSalary:(e/b).toFixed(2)},{label:"Female",count:c,averageSalary:(d/c).toFixed(2)}]}function slicePieByVeteran(a){for(var b=0,c=0,d=0,e=0,f=0;f<a.length;f++)a[f].veteran?(b++,a[f].employHistory.start&&a[f].wages.length>0&&(d+=a[f].wages[0])):(c++,a[f].employHistory.start&&a[f].wages.length>0&&(e+=a[f].wages[0]));return[{label:"Veteran",count:b,averageSalary:(d/b).toFixed(2)},{label:"Non-veterans",count:c,averageSalary:(e/c).toFixed(2)}]}function genLineData(){var a=[[{x:new Date(2012,5,7),y:2},{x:new Date(2012,8,7),y:4},{x:new Date(2013,10,7),y:6},{x:new Date(2014,11,7),y:7},{x:new Date(2015,12,7),y:9}],[{x:new Date(2012,5,7),y:10},{x:new Date(2012,8,7),y:8},{x:new Date(2013,10,7),y:6},{x:new Date(2014,11,7),y:6},{x:new Date(2015,12,7),y:5}]];return a}function buildLineData(a,b,c,d){var e=null,f=[],g=[],h=[],i=[],j="percentage";"Wage at Placement"==b&&(j="average");for(var k=0;k<a.length;k++)if(a[k].classStart)if(0!=h.length)for(var l=0;l<h.length&&h[l].date!=a[k].classStart;l++)l>=h.length-1&&h.push({date:a[k].classStart,sum:0});else h.push({date:a[k].classStart,sum:0});h.sort(function(a,b){return a.date<b.date?-1:a.date>b.date?1:0});for(var m=0;m<a.length;m++){var n=-1;if(e=lineGraphData(a[m],b,c,d)){for(var o=0;o<f.length;o++)if(f[o]==e.seriesName){n=o;break}if(0>n){n=f.length,f.push(e.seriesName),g.push([]);for(var p=0;p<h.length;p++)g[g.length-1].push({date:h[p].date,sum:0});i.push([])}for(var q=0;q<h.length;q++)Date.parse(h[q].date)==e.classStart&&(h[q].sum++,g[n][q].sum+=e.dataVal)}}for(var r=0;r<i.length;r++)for(var s=0;s<g[r].length;s++){var t=Date.parse(g[r][s].date),u=null;h[s]&&h[s].sum>0&&(u="percentage"==j?g[r][s].sum/h[s].sum*100:g[r][s].sum/h[s].sum),t&&!isNaN(t)&&u&&i[r].push({x:t,y:u})}var v=f.indexOf("calcAssist");return v>=0&&(f.splice(v,1),i.splice(v,1)),{chartType:j,seriesNames:f,graphData:i}}function lineGraphData(a,b,c,d){var e=null,f=null,g=Date.parse(a.classStart);if(isNaN(g)||isNaN(c)||isNaN(d))return null;var h=new Date(c);if(h.setDate(h.getDate()-1),h>g||g>d)return null;switch(b){case"Gender":f=a.female?"Female":"Male",e=1;break;case"Age":if(a.ageAtStart){var i=a.ageAtStart;e=1,f=18>i?"Under 18":24>i?"18 to 24":30>i?"24 to 30":40>i?"30 to 40":50>i?"40 to 50":"Over 50"}break;case"Race":a.ethnicity&&(f=a.ethnicity,e=1);break;case"Veteran Status":a.veteran?(f="Veteran",e=1):(f="calcAssist",e=1);break;case"Wage at Placement":a.wages&&a.wages.length>0&&(e=a.wages[0],f="Wage at Placement");break;case"Placement Rates":a.employHistory.start?(e=1,f="Placement Rate"):(f="calcAssist",e=1);break;case"Graduation Rates":a.gradDate?(e=1,f="Graduation Rate"):(f="calcAssist",e=1)}return null===e?null:{seriesName:f,classStart:g,dataVal:e}}function genLineGraph(a,b,c,d){console.log("yo, line chart");for(var e=850,f=500,g=60,h=buildLineData(a,b,c,d),i=h.graphData,j=h.seriesNames,k=d3.scale.category10(),l=[],m=0;m<j.length;m++)l.push({name:j[m],color:k(m)});var n=[0,100];"average"==h.chartType&&(n=d3.extent(d3.merge(i),function(a){return a.y}),n[0]/=1.5,n[1]*=1.25);var o=d3.time.scale().domain([c,d]).range([g,e-250]),p=d3.svg.axis().scale(o).orient("bottom").ticks(d3.time.months,6).tickSize(12,12).tickFormat(d3.time.format("%b. '%y")),q=d3.scale.linear().domain([n[0],n[1]]).range([f-g,g]);d3.select("#lineSVG").remove(),d3.select("#legendArea").remove();var r=d3.select("#line").append("svg").attr("id","lineSVG").attr("width",e).attr("height",f).attr("opacity","1"),s=d3.svg.axis().scale(q).orient("left").ticks(8);r.append("g").attr("class","axis").attr("transform","translate(0,"+(f-g)+")").call(p),r.append("g").attr("class","axis").attr("transform","translate("+g+",0)").call(s).append("text").attr("transform","rotate(-90)").attr("y",6).attr("x",-200).attr("dy","-3em").style("text-anchor","end").text("Percent (%)");var t=r.selectAll("g.line").data(i);t.enter().append("g").attr("class","line").attr("style",function(a){return"stroke: "+k(i.indexOf(a))}),t.selectAll("path").data(function(a){return[a]}).enter().append("path").attr("d",d3.svg.line().x(function(a){return o(a.x)}).y(function(a){return q(a.y)}));var u=d3.select("#lineControlPanel").append("svg").attr("id","legendArea"),v=u.append("g").attr("class","legend");v.selectAll("rect").data(i).enter().append("rect").attr("x",5).attr("y",function(a,b){return 24*b}).attr("width",15).attr("height",15).style("fill",function(a){return l[i.indexOf(a)].color}),v.selectAll("text").data(i).enter().append("text").attr("x",25).attr("y",function(a,b){return 24*b+11}).text(function(a){return l[i.indexOf(a)].name})}var app=angular.module("myApp",["ngRoute"]);app.controller("MainController",["$scope","$location","SmartSheetService",function(a,b,c){function d(a,b,c,d){var e={},f=Date.parse(a.classStart);if(isNaN(f)||isNaN(b)||isNaN(c))return null;if(f>c||b>f)return null;var g=0,h=0,i=Date.parse(a.employHistory.start),j=Date.parse(a.employHistory.end);i&&!isNaN(i)&&(h=((new Date-i)/1e3/3600/24).toFixed(0),g=j&&!isNaN(j)?(j-i)/1e3/3600/24:-1);for(var k=Object.keys(d),l=0;l<k.length&&!(h<d[k[l]]);l++){if(!(0>g||g>=d[k[l]])){for(var m=l;m<k.length&&!(h<d[k[m]]);m++)e[k[m]]=!1;break}e[k[l]]=!0}return e}function e(a,b,c){for(var e={threeMonth:90,sixMonth:180,oneYear:365,twoYear:730,threeYear:1095,fourYear:1460,fiveYear:1825},f=Object.keys(e),g={},h={},i=0;i<f.length;i++)g[f[i]]={numRetained:0,fraction:null,percent:null},h[f[i]]=0;var j={},k={};for(i=0;i<a.length;i++)if(j=d(a[i],b,c,e)){k=Object.keys(j);for(var l=0;l<k.length;l++)j[k[l]]&&g[k[l]].numRetained++,h[k[l]]++}for(i=0;i<f.length;i++)h[f[i]]<=0?(g[f[i]].fraction="N/A",g[f[i]].percent="N/A"):(g[f[i]].fraction=g[f[i]].numRetained+" / "+h[f[i]],g[f[i]].percent=(g[f[i]].numRetained/h[f[i]]*100).toFixed(1)+"%");return g}function f(a,b,c){for(var d=0,e=0,f=0,h=0;h<a.length;h++)f=g(a[h],b,c),f&&(d+=f,e++);return(d/e).toFixed(2)}function g(a,b,c){var d=Date.parse(a.classStart);return isNaN(d)||isNaN(b)||isNaN(c)?null:a.employHistory.start&&d>=b&&c>=d&&a.wages.length>0?a.wages[0]:null}function h(a,b,c){for(var d=0,e=0,f=0,g=0;g<a.length;g++)f=i(a[g],b,c),f&&(d+=f,e++);return(d/e).toFixed(2)}function i(a,b,c){var d=Date.parse(a.classStart);return isNaN(d)||isNaN(b)||isNaN(c)?null:a.employHistory.start&&!a.employHistory.end&&d>=b&&c>=d&&a.wages.length>0?a.wages[a.wages.length-1]:null}function j(a,b,c,d){var e=0,f=0,g=0,h={};if(isNaN(c)||isNaN(d))return null;for(var j=0;j<b.length;j++){var k=Date.parse(b[j].classStart);if(!isNaN(k)&&k>=c&&d>=k)for(var l=0;l<a.length;l++){var m=a[l];if(!b[j][m])break;l==a.length-1&&(f=i(b[j],c,d),f&&(e+=f,g++))}}return h.avgWage=(e/g).toFixed(2),h.count=g,h}function k(b,c,d){if(isNaN(c)||isNaN(d))return null;var e={};a.topFive=[];for(var f=0;f<b.length;f++){var g=Date.parse(b[f].classStart);if(!isNaN(g)&&g>=c&&d>=g)for(var h=0;h<b[f].distinctEmployers.length;h++){var i=b[f].distinctEmployers[h];e.hasOwnProperty(i)||(e[i]=0),e[i]++}}a.sortedEmployers=n(e);for(var j=0;5>j;j++)a.topFive.push(a.sortedEmployers.pop());return a.topFive}function l(a,b){var c=b;return a&&c.number++,c}function m(b){var c=b;return c.number&&(c.percent=Number(Math.round(c.number/a.numServed*100+"e2")+"e-2")),c}function n(a){var b,c=[];for(b in a)a.hasOwnProperty(b)&&c.push({key:b,value:a[b]});return c.sort(function(a,b){return a.value-b.value}),c}a.endDate=new Date,a.startDate=new Date("2012-05-08"),a.smartSheetData=[],c.getSmartSheetData().then(function(b){a.smartSheetData=b.data,console.log(a.smartSheetData),a.submitDate()}),a.genLineGraph=genLineGraph,a.submitDate=function(){a.numServed=0,a.completed={number:0,percent:0},a.certified={number:0,percent:0},a.placed={number:0,percent:0},a.certNetwork={number:0,percent:0},a.certServer={number:0,percent:0},a.certSecurity={number:0,percent:0},a.networkPlus=!1,a.securityPlus=!1,a.serverPlus=!1,a.otherCert=!1,a.calculatedSalary={};for(var b=0;b<a.smartSheetData.length;b++){var c=new Date(a.smartSheetData[b].classStart),d=c.setDate(c.getDate()+1);d>=a.startDate&&d<=a.endDate&&(a.numServed++,a.completed=l(a.smartSheetData[b].gradDate,a.completed),a.certified=l(a.smartSheetData[b].certDate,a.certified),a.placed=l(a.smartSheetData[b].employHistory.start,a.placed),a.certNetwork=l(a.smartSheetData[b].networkPlus,a.certNetwork),a.certServer=l(a.smartSheetData[b].serverPlus,a.certServer),a.certSecurity=l(a.smartSheetData[b].securityPlus,a.certSecurity))}a.completed=m(a.completed),a.certified=m(a.certified),a.placed=m(a.placed),a.certNetwork=m(a.certNetwork),a.certServer=m(a.certServer),a.certSecurity=m(a.certSecurity);var g=new Date(a.startDate);g.setDate(g.getDate()-1),a.avgWageAtPlacement=f(a.smartSheetData,g,Date.parse(a.endDate)),a.avgCurrentWage=h(a.smartSheetData,g,Date.parse(a.endDate)),a.getTopFive=k(a.smartSheetData,g,Date.parse(a.endDate)),a.retentionData=e(a.smartSheetData,g,Date.parse(a.endDate)),a.generatePieCharts(),a.genLineGraph(a.smartSheetData,a.selectedLineGraph,Date.parse(a.startDate),Date.parse(a.endDate))},a.calcAvgSalary=function(){a.tempCertArray=[],a.networkPlus&&a.tempCertArray.push("networkPlus"),a.serverPlus&&a.tempCertArray.push("serverPlus"),a.securityPlus&&a.tempCertArray.push("securityPlus"),a.otherCert&&a.tempCertArray.push("otherCert");var b=new Date(a.startDate);b.setDate(b.getDate()-1),a.calculatedSalary=j(a.tempCertArray,a.smartSheetData,b,Date.parse(a.endDate))},a.generatePieCharts=function(){d3.select("svg").remove();var b=new Date(a.startDate);b.setDate(b.getDate()-1),a.selectedDisplay=a.selectedProgress;var c=[],d=[];a.pieHeading="",c=getRange(a.smartSheetData,b,Date.parse(a.endDate),a.selectedProgress),"Race"==a.selectedDemographic?(d=slicePieByRace(c),a.pieHeading="Race"):"Age"==a.selectedDemographic?(d=slicePieByAge(c),a.pieHeading="Age"):"Gender"==a.selectedDemographic?(d=slicePieByGender(c),a.pieHeading="Gender"):"Veteran Status"==a.selectedDemographic&&(d=slicePieByVeteran(c),a.pieHeading="Veteran Status");var e=650,f=400,g=Math.min(e,f)/2,h=18,i=4,j=d3.scale.category10(),k=d3.select("#chart").append("svg").attr("width",e).attr("height",f).append("g").attr("transform","translate("+e/2+","+f/2+")"),l=d3.svg.arc().outerRadius(g),m=d3.layout.pie().value(function(a){return a.count}).sort(null),n=d3.select("#chart").append("div").attr("class","tooltips");n.append("div").attr("class","label"),n.append("div").attr("class","count"),n.append("div").attr("class","percent"),d.forEach(function(a){a.count=+a.count,a.enabled=!0,n.select(".label").html("Mouse over"),n.select(".count").html("chart to"),n.select(".percent").html("view percents")});var o=k.selectAll("path").data(m(d)).enter().append("path").attr("d",l).attr("fill",function(a,b){return j(a.data.label)}).each(function(a){this._current=a});o.on("mouseover",function(a){var b=d3.sum(d.map(function(a){return a.enabled?a.count:0})),c=Math.round(1e3*a.data.count/b)/10;n.select(".label").html(a.data.label),n.select(".count").html(a.data.count),n.select(".percent").html(c+"%"),n.select(".tooltips").style("text-align","center")}),o.on("mouseout",function(){n.style("display","none")});var p=k.selectAll(".legend").data(j.domain()).enter().append("g").attr("class","legend").attr("transform",function(a,b){var c=h+i,d=c*j.domain().length/2,e=-17*h,f=b*c-d-140;return"translate("+e+","+f+")"});p.append("rect").attr("width",h).attr("height",h).style("fill",j).style("stroke",j).on("click",function(a){var b=d3.select(this),c=!0,e=d3.sum(d.map(function(a){return a.enabled?1:0}));if("disabled"===b.attr("class"))b.attr("class","");else{if(2>e)return;b.attr("class","disabled"),c=!1}m.value(function(b){return b.label===a&&(b.enabled=c),b.enabled?b.count:0}),o=o.data(m(d)),o.transition().duration(750).attrTween("d",function(a){var b=d3.interpolate(this._current,a);return this._current=b(0),function(a){return l(b(a))}})}),p.append("text").attr("x",h+i).attr("y",h-i).text(function(a){return a})},a.demographicList=["Gender","Age","Race","Veteran Status"],a.progressList=["Served","Completed","Certified A+","Placed"],a.lineGraphList=["Gender","Age","Race","Veteran Status","Wage at Placement","Placement Rates","Graduation Rates"],a.selectedDemographic="Gender",a.selectedProgress="Served",a.selectedLineGraph="Gender",a.tab="a",a.chartTab="pie",a.averageShow=!1,a.showAverageSalary=function(){a.averageShow=!0},a.hideAverageSalary=function(){a.averageShow=!1}}]),app.factory("SmartSheetService",["$http",function(a){var b=function(){return a.get("/api")};return{getSmartSheetData:b}}]);